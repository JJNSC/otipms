<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.otipms.dao.EmployeeDao">
	<insert id="insertEmployee" parameterType="Employee">	
		<selectKey keyProperty="empId" resultType="int" order="BEFORE">
			select emp_seq.nextval from dual <!-- 시퀀스의 다음 번호를 가지고온다. 그리고 다음단계=>세팅하기 -->
		</selectKey>
		INSERT INTO emp (EmpId, EmpPW, EmpName, EmpRank, Role,, EmpEnabled) VALUES (TO_CHAR(SYSDATE, 'YY') ||0||0|| #{empId}, #{empPw}, #{empName}, #{empRank}, #{role},1)
	</insert>
	
	<insert id="insertEmployeeInfo" parameterType="Employee">	
		INSERT INTO empInfo (empId,TeamNo, empTel) VALUES
		<if test="teamNo ==0">
			 (#{empId}, null, #{empTel})
		</if>
		<if test="teamNo !=0">
			(#{empId}, #{teamNo}, #{empTel})
		</if>
		
	</insert>
	
	<select id="selectByEmployeeId" parameterType="int" resultType="Employee">
		select *
		  from emp 
		 where 1=1
		   AND empId = #{empId}
	</select>
	
	<select id="selectInfoByEmployeeId" parameterType="int" resultType="Employee">
		select * from empInfo where empId = #{empId}
	</select>
	
	<select id="getTeamNoByTeamName" parameterType="String" resultType="int">
		select teamNo from team where teamName=#{teamName}
	</select>
	
	<select id="getEmployeeByTeamNo" parameterType="int" resultType="Employee">
		select *
			from emp e, empinfo ei
			where e.empId = ei.empId and teamNo = #{teamNo}
	</select>
	
	<select id="checkEmployeeByTel" parameterType="String" resultType="int">
		select count(*) from empInfo where empTel=#{empTel}
	</select>
	
	<select id="selectAllEmployee" resultType="Employee">
		select p.projectName, t.teamName, e.empRank, e.empName, e.empId
		    from emp e, empinfo ei, team t, project p
		    where e.empId = ei.empId
		        and p.projectNo = t.projectNo
		        and t.teamNo = ei.teamNo
	</select>
	
	<update id="updateTeamNo" parameterType="Employee">
		UPDATE empInfo 
		   SET
			   <if test="teamNo==0">
			      teamNo = null
			   </if>
			   <if test="teamNo!=0">
				  teamNo = #{teamNo}
			   </if>
		 WHERE empId = #{empId}
	</update>
	
	<select id="selectEmployeeByRole" parameterType="String" resultType="Employee">
		select e.*, eif.emptel, eif.empemail from emp e inner join (select  empid ,emptel, empemail from empinfo ) eif
		on e.empid = eif.empid 
		where role=#{role}
	</select>
	
	<select id="selectEmployeeByTeamNo" parameterType="int" resultType="Employee">
		SELECT e.empId
			 , e.empName
			 , e.empRank
			 , e.role
		  FROM emp e 
    INNER JOIN (
    			SELECT * 
     			  FROM empInfo
     		   ) eif 
     	    ON e.empId = eif.empId 
     	 WHERE 1=1
     	   AND teamNo=#{teamNo} 
	</select>

</mapper>