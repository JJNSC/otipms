<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.otipms.dao.AlarmDao">
	
	<select id="selectAlarmByEmpId" parameterType="int" resultType="Alarm">
		  SELECT a.AlarmNo
		  	   , a.empId AS alarmEmpId
		  	   , a.AlarmContentCode
		  	   , a.AlarmContent
		  	   , a.AlarmDate
		  	   , a.AlarmChk
		  	   , a.MessageNo AS alarmMessageNo
		    FROM Alarm a
      INNER JOIN emp e
		      ON a.empId = e.empId
		   WHERE a.empId = #{empId}
		     AND e.empEnabled = 1
		ORDER BY a.AlarmDate desc
	</select>
	<select id="selectAlarmCountByEmpId" parameterType="int" resultType="Alarm">
		  SELECT a.AlarmNo
		  	   , a.EmpId AS alarmEmpId
		  	   , a.AlarmContentCode
		  	   , a.AlarmContent
		  	   , a.AlarmDate
		  	   , a.AlarmChk
		  	   , a.MessageNo AS alarmMessageNo
		    FROM Alarm a
      INNER JOIN emp e
		      ON a.EmpId = e.EmpId
	  INNER JOIN message m
	  		  ON m.messageNo = a.messageNo
		   WHERE a.EmpId = #{empId}
		     AND e.empEnabled = 1
   AND TO_NUMBER(a.AlarmChk) = 0
	</select>
	
	<select id="selectAlarmCountByEmpIdI" parameterType="java.lang.Integer" resultType="Alarm">
		  SELECT a.AlarmNo
		  	   , a.EmpId AS alarmEmpId
		  	   , a.AlarmContentCode
		  	   , a.AlarmContent
		  	   , a.AlarmDate
		  	   , a.AlarmChk
		  	   , a.MessageNo AS alarmMessageNo
		    FROM Alarm a
      INNER JOIN emp e
		      ON a.EmpId = e.EmpId
	  INNER JOIN message m
	  		  ON m.messageNo = a.messageNo
		   WHERE a.EmpId = #{alarmEmpId}
		     AND e.empEnabled = 1
   AND TO_NUMBER(a.AlarmChk) = 0
	</select>
	
	<insert id="insertAlarm" parameterType="Alarm">
		<selectKey keyProperty="alarmNo" resultType="int" order="BEFORE">
			 SELECT alarmNo_seq.nextval 
			   FROM DUAL
		</selectKey>
		INSERT INTO ALARM 
		          (
		            alarmNo
		          , empId
		          , alarmContentCode
		          , alarmContent
		          , alarmDate
		          , alarmChk
		          , messageNo
		          )
			 VALUES 
			      ( #{alarmNo}
			      , #{alarmEmpId}
			      , #{alarmContentCode}
			      , #{alarmContent}
			      , SYSDATE
			      , 0
			      , #{alarmMessageNo}
			      )
	</insert>
	
	<update id="checkedAlarm" parameterType="Alarm">
		UPDATE ALARM
    	   SET alarmChk = 1
    	 WHERE alarmNo = #{alarmNo}
           AND alarmChk = 0
	</update>
	
	<!-- 알람번호로 쪽지 찾기1 -->
	<select id="selectAlarm" parameterType="int" resultType="Alarm">
		SELECT AlarmNo
		  	 , empId AS alarmEmpId
		  	 , AlarmContentCode
		  	 , AlarmContent
		  	 , AlarmDate
		  	 , AlarmChk
		  	 , messageNo AS alarmMessageNo
		  FROM ALARM
		 WHERE alarmNo = #{alarmNo}
	</select>
	
	<!-- 메시지번호로 알림 찾기2 -->
	<select id="selectAlarmByMessageNo" parameterType="java.util.Map" resultType="Alarm">
		SELECT *
		  FROM ALARM
		 WHERE messageNo = #{alarmMessageNo}
		   AND empId = #{alarmEmpId}
	</select>
	
	<!-- 알람 지우기(쪽지 발송 취소) -->
	<delete id="deleteAlarm" parameterType="map">
		DELETE FROM ALARM
	     WHERE messageNo = #{messageNo}
           AND empId = #{empId}
	</delete>
	
	<!-- 알람 전체 삭제(사원번호) -->
	<delete id="deleteAlarmAll" parameterType="int">
		DELETE FROM ALARM
		 	  WHERE empId = #{empId}
	</delete>
</mapper>